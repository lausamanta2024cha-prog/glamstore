{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento de Pedido #{{ pedido.idPedido }} | Glam Store</title>
  <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
  <style>
    .container { margin-left: 240px; padding: 2rem 5rem; width: calc(100% - 240px - 10rem); max-width: 1200px; margin-right: auto; }
    .header { background: #fff; padding: 2.5rem; border-radius: 15px; box-shadow: 0 4px 16px rgba(168, 85, 247, 0.12); margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e9d5ff; }
    .header h1 { color: #1a1a1a; font-size: 2rem; font-weight: 700; letter-spacing: 0.3px; }
    .btn-back { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: white; padding: 0.9rem 1.8rem; border-radius: 25px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 16px rgba(168, 85, 247, 0.3); border: none; cursor: pointer; font-size: 0.95rem; }
    .btn-back:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(168, 85, 247, 0.4); background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); }
    .btn-back:active { transform: translateY(-1px); }
    .pedido-info { background: #fff; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 16px rgba(168, 85, 247, 0.12); margin-bottom: 2rem; border: 1px solid #e9d5ff; transition: all 0.3s ease; }
    .pedido-info:hover { box-shadow: 0 6px 24px rgba(168, 85, 247, 0.15); }
    .pedido-info h2 { color: #7c3aed; font-size: 1.4rem; margin-bottom: 1.5rem; border-bottom: 3px solid #a855f7; padding-bottom: 0.8rem; font-weight: 600; letter-spacing: 0.3px; }
    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.2rem; }
    .info-item { padding: 1.2rem; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; border: 1px solid #d8b4fe; transition: all 0.3s ease; }
    .info-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15); }
    .info-item strong { display: block; color: #7c3aed; font-size: 0.8rem; margin-bottom: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .info-item span { color: #1a1a1a; font-size: 1rem; font-weight: 500; }
    .timeline-container { background: #fff; padding: 2.5rem; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); }
    .timeline-container h2 { color: #7c3aed; font-size: 1.5rem; margin-bottom: 2rem; border-bottom: 2px solid #a855f7; padding-bottom: 0.8rem; font-weight: 600; }
    .status-badge { display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; margin-bottom: 1.5rem; }
    .status-badge.pago-completo { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; }
    .status-badge.pago-parcial { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; }
    .status-badge.en-preparacion { background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; }
    .status-badge.en-camino { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: white; }
    .status-badge.entregado { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; }
    .timeline { position: relative; padding-left: 3rem; }
    .timeline::before { content: ''; position: absolute; left: 1rem; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, #a855f7 0%, #e9d5ff 100%); }
    .timeline-item { position: relative; padding-bottom: 2.5rem; }
    .timeline-item:last-child { padding-bottom: 0; }
    .timeline-icon { position: absolute; left: -2.5rem; width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); z-index: 1; }
    .timeline-item.completed .timeline-icon { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; }
    .timeline-item.active .timeline-icon { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: white; animation: pulse 2s infinite; }
    .timeline-item.pending .timeline-icon { background: #faf5ff; color: #a855f7; border: 2px solid #d8b4fe; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7); } 50% { box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); } }
    .timeline-content { background: #faf5ff; padding: 1.5rem; border-radius: 10px; border-left: 3px solid #d8b4fe; }
    .timeline-item.completed .timeline-content { border-left-color: #4caf50; }
    .timeline-item.active .timeline-content { border-left-color: #a855f7; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); }
    .timeline-title { font-size: 1.1rem; font-weight: 600; color: #7c3aed; margin-bottom: 0.5rem; }
    .timeline-item.active .timeline-title { color: #a855f7; }
    .timeline-description { color: #666; font-size: 0.95rem; line-height: 1.6; }
    .timeline-date { color: #999; font-size: 0.85rem; margin-top: 0.5rem; }
    table { width: 100%; }
    table th, table td { padding: 0.8rem; text-align: left; }
    table thead { background-color: #e9d5ff; border-bottom: 2px solid #a855f7; }
    table th { color: #7c3aed; font-weight: 600; }
    table tbody tr { border-bottom: 1px solid #e9d5ff; }
    table tbody tr:hover { background-color: #faf5ff; }
    table td { color: #1a1a1a; }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .container { margin-left: 0; padding: 2rem; width: 100%; }
      .header { flex-direction: column; gap: 1rem; text-align: center; }
      .timeline { padding-left: 2.5rem; }
      .timeline-icon { left: -2rem; width: 2rem; height: 2rem; font-size: 1rem; }
      .info-grid { grid-template-columns: 1fr; }
      table { font-size: 0.9rem; }
      table th, table td { padding: 0.6rem; }
      table th { font-size: 0.85rem; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <aside class="sidebar">
    <img src="{% static 'img/logoglam.png' %}" alt="Glam Store Logo" class="logo">
    <h1>Glam Store</h1>
    <p>Tu tienda de belleza</p>
    <nav>
      <ul>
        <li><a href="{% url 'tienda' %}">Tienda</a></li>
        <li><a href="{% url 'ver_carrito' %}">Carrito</a></li>
        <li><a href="{% url 'perfil' %}">Mi Perfil</a></li>
        <li><a href="{% url 'logout' %}">Cerrar Sesión</a></li>
      </ul>
    </nav>
  </aside>

  <div class="container">
    <div class="header">
      <h1>Seguimiento de Pedido #{{ pedido.idPedido }}</h1>
      <a href="{% url 'perfil' %}" class="btn-back">← Volver al Perfil</a>
    </div>

    <div class="pedido-info">
      <h2>Información del Pedido</h2>
      <div class="info-grid">
        <div class="info-item"><strong>Estado Pago</strong><span>{{ pedido.estado_pago }}</span></div>
        <div class="info-item"><strong>Estado Pedido</strong><span>{{ pedido.estado_pedido }}</span></div>
        <div class="info-item"><strong>Fecha</strong><span>{{ pedido.fechaCreacion|date:"d/m/Y H:i" }}</span></div>
        <div class="info-item"><strong>Cliente</strong><span>{{ pedido.idCliente.nombre }}</span></div>
        <div class="info-item"><strong>Teléfono</strong><span>{{ pedido.idCliente.telefono }}</span></div>
        <div class="info-item"><strong>Dirección</strong><span>{{ pedido.idCliente.direccion }}</span></div>
        <div class="info-item"><strong>Fecha de Entrega Estimada</strong><span>{{ fecha_entrega_estimada|date:"d/m/Y" }} ({{ dias_entrega }} días hábiles)</span></div>
        <div class="info-item"><strong>Ciudad de Entrega</strong><span>{{ ciudad_entrega }}</span></div>
        {% if pedido.idRepartidor %}
        <div class="info-item"><strong>Repartidor Asignado</strong><span>{{ pedido.idRepartidor.nombreRepartidor }}</span></div>
        <div class="info-item"><strong>Teléfono Repartidor</strong><span>{{ pedido.idRepartidor.telefono }}</span></div>
        {% endif %}
      </div>
    </div>

    <div class="pedido-info">
      <h2>Productos Comprados</h2>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #e9d5ff; border-bottom: 2px solid #a855f7;">
              <th style="padding: 1rem; text-align: center; color: #7c3aed; font-weight: 600;">Imagen</th>
              <th style="padding: 1rem; text-align: left; color: #7c3aed; font-weight: 600;">Producto</th>
              <th style="padding: 1rem; text-align: center; color: #7c3aed; font-weight: 600;">Cantidad</th>
              <th style="padding: 1rem; text-align: right; color: #7c3aed; font-weight: 600;">Precio Unitario</th>
              <th style="padding: 1rem; text-align: right; color: #7c3aed; font-weight: 600;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for detalle in detalles_pedido %}
            <tr style="border-bottom: 1px solid #e9d5ff;">
              <td style="padding: 1rem; text-align: center;">
                {% if detalle.idProducto.imagen %}
                  {% if detalle.idProducto.imagen.url %}
                    <img src="{{ detalle.idProducto.imagen.url }}" alt="{{ detalle.idProducto.nombreProducto }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">
                  {% else %}
                    <img src="/media/{{ detalle.idProducto.imagen }}" alt="{{ detalle.idProducto.nombreProducto }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);">
                  {% endif %}
                {% else %}
                  <div style="width: 60px; height: 60px; background: #e9d5ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #7c3aed; font-size: 0.8rem;">Sin imagen</div>
                {% endif %}
              </td>
              <td style="padding: 1rem; color: #1a1a1a;">{{ detalle.idProducto.nombreProducto }}</td>
              <td style="padding: 1rem; text-align: center; color: #1a1a1a;">{{ detalle.cantidad }}</td>
              <td style="padding: 1rem; text-align: right; color: #1a1a1a;">${{ detalle.precio_unitario|floatformat:0|intcomma }}</td>
              <td style="padding: 1rem; text-align: right; color: #7c3aed; font-weight: 600;">${{ detalle.subtotal|floatformat:0|intcomma }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div style="margin-top: 2rem; padding: 1.5rem; background: #faf5ff; border-radius: 10px; border: 1px solid #d8b4fe;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #e9d5ff;">
          <span style="color: #1a1a1a;">Sub Total:</span>
          <strong style="color: #1a1a1a;">${{ total_productos|floatformat:0|intcomma }}</strong>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #e9d5ff;">
          <span style="color: #1a1a1a;">IVA (19%):</span>
          <strong style="color: #1a1a1a;" id="iva-seguimiento">$0</strong>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #e9d5ff;">
          <span style="color: #1a1a1a;">Envío:</span>
          <span style="color: #1a1a1a;">
            {% if envio_pagado %}
              <span style="color: #4caf50;">✓ Pagado</span> - ${{ costo_envio }}
            {% else %}
              <span style="color: #ff9800;">Contra Entrega</span> - ${{ costo_envio }}
            {% endif %}
          </span>
        </div>
        <div style="display: flex; justify-content: space-between; padding-top: 0.8rem;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #7c3aed;">Total del Pedido:</span>
          <strong style="font-size: 1.2rem; color: #a855f7;">${{ pedido.total|floatformat:0|intcomma }}</strong>
        </div>
      </div>

      {% if pedido.estado_pago == 'Pago Parcial' %}
      <div style="margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 10px; border-left: 4px solid #ff9800;">
        <div style="display: flex; align-items: flex-start; gap: 1rem;">
          <div>
            <strong style="color: #e65100; display: block; margin-bottom: 0.5rem; font-size: 1.1rem;">Recordatorio: Pago Pendiente Contra Entrega</strong>
            <p style="color: #bf360c; margin: 0; line-height: 1.6;">Tienes un saldo pendiente de <strong>$10.000</strong> que deberás pagar al momento de la entrega al Repartidor.</p>
          </div>
        </div>
      </div>
      {% endif %}

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const baseLiquida = parseFloat('{{ total_productos }}');
          const tasaIVA = 0.19;
          const iva = Math.round(baseLiquida * tasaIVA);
          document.getElementById('iva-seguimiento').textContent = '$' + iva.toLocaleString('es-CO');
        });
      </script>
    </div>

    <div class="timeline-container">
      <h2>Estado del Pedido</h2>
      <div class="status-badge {% if pedido.estado_pago == 'Pago Completo' %}pago-completo{% elif pedido.estado_pago == 'Pago Parcial' %}pago-parcial{% endif %}">{{ pedido.estado_pago }}</div>
      <div class="status-badge {% if pedido.estado_pedido == 'En Preparación' %}en-preparacion{% elif pedido.estado_pedido == 'En Camino' %}en-camino{% elif pedido.estado_pedido == 'Entregado' %}entregado{% endif %}">{{ pedido.estado_pedido }}</div>
      
      <!-- Barra de progreso visual -->
      <div style="margin: 1.5rem 0; display: flex; gap: 0.5rem; align-items: center;">
        <div style="flex: 1; height: 8px; background: #e9d5ff; border-radius: 4px; overflow: hidden;">
          <div style="height: 100%; background: linear-gradient(90deg, #a855f7 0%, #9333ea 100%); border-radius: 4px; width: {% if pedido.estado_pedido == 'En Preparación' %}0%{% elif pedido.estado_pedido == 'En Camino' %}90%{% elif pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}100%{% else %}0%{% endif %};"></div>
        </div>
        <span style="font-size: 0.8rem; color: #999; white-space: nowrap; font-weight: 600;">
          {% if pedido.estado_pedido == 'En Preparación' %}
          0%
          {% elif pedido.estado_pedido == 'En Camino' %}
          90%
          {% elif pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}
          100%
          {% else %}
          0%
          {% endif %}
        </span>
      </div>

      <div class="timeline">
        <div class="timeline-item completed">
          <div class="timeline-icon">✓</div>
          <div class="timeline-content">
            <div class="timeline-title">Pedido Recibido</div>
            <div class="timeline-description">Tu pedido ha sido registrado exitosamente en nuestro sistema.</div>
            <div class="timeline-date">{{ pedido.fechaCreacion|date:"d/m/Y H:i" }}</div>
          </div>
        </div>

        <div class="timeline-item {% if pedido.estado_pedido == 'Pago Confirmado' or pedido.estado_pedido == 'En Preparación' or pedido.estado_pedido == 'En Camino' or pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}completed{% elif pedido.estado_pago == 'Pago Parcial' %}active{% else %}pending{% endif %}">
          <div class="timeline-icon">{% if pedido.estado_pedido == 'Pago Confirmado' or pedido.estado_pedido == 'En Preparación' or pedido.estado_pedido == 'En Camino' or pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}✓{% elif pedido.estado_pago == 'Pago Parcial' %}2{% else %}2{% endif %}</div>
          <div class="timeline-content">
            <div class="timeline-title">Pago Confirmado</div>
            <div class="timeline-description">
              {% if pedido.estado_pedido == 'Pago Confirmado' or pedido.estado_pedido == 'En Preparación' or pedido.estado_pedido == 'En Camino' or pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}
                El pago ha sido confirmado. Tu pedido está siendo procesado.
              {% elif pedido.estado_pago == 'Pago Parcial' %}
                Pago parcial recibido. El saldo restante se pagará contra entrega.
              {% else %}
                Esperando confirmación de pago.
              {% endif %}
            </div>
          </div>
        </div>

        <div class="timeline-item {% if pedido.estado_pedido == 'En Preparación' %}active{% elif pedido.estado_pedido == 'En Camino' or pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}completed{% else %}pending{% endif %}">
          <div class="timeline-icon">{% if pedido.estado_pedido == 'En Camino' or pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}✓{% elif pedido.estado_pedido == 'En Preparación' %}3{% else %}3{% endif %}</div>
          <div class="timeline-content">
            <div class="timeline-title">En Preparación</div>
            <div class="timeline-description">
              {% if pedido.estado_pedido == 'En Preparación' %}
                Tu pedido será preparado una vez confirmado el pago.
              {% elif pedido.estado_pedido == 'En Camino' or pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}
                Tu pedido fue preparado y empacado correctamente.
              {% else %}
                Tu pedido será preparado una vez confirmado el pago.
              {% endif %}
            </div>
          </div>
        </div>

        <div class="timeline-item {% if pedido.estado_pedido == 'En Camino' %}active{% elif pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}completed{% else %}pending{% endif %}">
          <div class="timeline-icon">{% if pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}✓{% elif pedido.estado_pedido == 'En Camino' %}4{% else %}4{% endif %}</div>
          <div class="timeline-content">
            <div class="timeline-title">En Camino</div>
            <div class="timeline-description">
              {% if pedido.estado_pedido == 'En Camino' %}
                Tu pedido está en camino a {{ ciudad_entrega }}. <br><strong>Fecha estimada de entrega: {{ fecha_entrega_estimada|date:"d/m/Y" }}</strong>
                {% if pedido.idRepartidor %}
                  <div style="margin-top: 1rem; padding: 1rem; background: #faf5ff; border-radius: 8px; border-left: 3px solid #a855f7;">
                    <strong style="color: #7c3aed; display: block; margin-bottom: 0.5rem;">Datos del Repartidor</strong>
                    <div style="color: #1a1a1a; font-size: 0.95rem;">
                      <div style="margin-bottom: 0.5rem;"><strong>Nombre:</strong> {{ pedido.idRepartidor.nombreRepartidor }}</div>
                      <div style="margin-bottom: 0.5rem;"><strong>Teléfono:</strong> {{ pedido.idRepartidor.telefono }}</div>
                    </div>
                  </div>
                {% endif %}
              {% elif pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}
                Tu pedido fue enviado y entregado exitosamente.
                {% if pedido.idRepartidor %}
                  <div style="margin-top: 1rem; padding: 1rem; background: #f0f8f0; border-radius: 8px; border-left: 3px solid #4caf50;">
                    <strong style="color: #2e7d32; display: block; margin-bottom: 0.5rem;">Repartidor que entregó</strong>
                    <div style="color: #1a1a1a; font-size: 0.95rem;">
                      <div style="margin-bottom: 0.5rem;"><strong>Nombre:</strong> {{ pedido.idRepartidor.nombreRepartidor }}</div>
                      <div><strong>Teléfono:</strong> {{ pedido.idRepartidor.telefono }}</div>
                    </div>
                  </div>
                {% endif %}
              {% else %}
                Tu pedido será enviado una vez esté listo. <br><strong>Fecha estimada de entrega: {{ fecha_entrega_estimada|date:"d/m/Y" }}</strong>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="timeline-item {% if pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}completed{% else %}pending{% endif %}">
          <div class="timeline-icon">{% if pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}✓{% else %}5{% endif %}</div>
          <div class="timeline-content">
            <div class="timeline-title">Entregado</div>
            <div class="timeline-description">
              {% if pedido.estado_pedido == 'Entregado' or pedido.estado_pedido == 'Completado' %}
                ¡Tu pedido ha sido entregado en {{ ciudad_entrega }}! Gracias por tu compra.
                {% if pedido.estado_pago == 'Pago Parcial' %}
                <br><em>El pago del envío fue completado al momento de la entrega.</em>
                {% endif %}
              {% else %}
                Tu pedido será entregado en {{ ciudad_entrega }} el {{ fecha_entrega_estimada|date:"d/m/Y" }}. <br><em>Dirección: {{ pedido.idCliente.direccion }}</em>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
