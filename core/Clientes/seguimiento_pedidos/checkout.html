{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Checkout ‚Äî GlamStore</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:ital,wght@1,700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Comic Neue', cursive; background-color: #fffafc; color: #880e4f; display: flex; margin: 0; }
    .sidebar { background-color: #fce4ec; padding: 2rem; width: 240px; height: 100vh; position: fixed; display: flex; flex-direction: column; align-items: center; text-align: center; border-right: 2px solid #f8bbd0; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); z-index: 1000; overflow-y: auto; }
    .logo { width: 100px; border-radius: 50%; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); margin-bottom: 1rem; }
    .sidebar h1 { color: #ad1457; font-size: 1.8rem; margin: 0.5rem 0; }
    .sidebar p { color: #d81b60; font-size: 1rem; margin-bottom: 2rem; }
    .sidebar nav ul { list-style: none; padding: 0; width: 100%; }
    .sidebar nav a { display: block; padding: 0.8rem 1.5rem; margin-bottom: 0.8rem; text-decoration: none; color: #880e4f; font-weight: bold; border-radius: 25px; transition: background-color 0.3s, color 0.3s; }
    .sidebar nav a:hover { background-color: #f8bbd0; color: #fff; }
    .main-content { margin-left: 240px; padding: 2rem; width: calc(100% - 240px); min-height: 100vh; }
    h2.titulo-checkout { font-size: 2.2rem; color: #c2185b; border-bottom: 3px solid #f48fb1; padding-bottom: 0.5rem; margin-bottom: 2rem; }
    .checkout-container { display: flex; flex-wrap: wrap; gap: 2rem; justify-content: space-between; }
    .formulario { flex: 1 1 55%; background: #fff5f8; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 10px rgba(212, 144, 192, 0.2); }
    .resumen { flex: 1 1 40%; background: #fff5f8; padding: 2rem; border-radius: 16px; position: sticky; top: 2rem; align-self: flex-start; box-shadow: 0 4px 10px rgba(212, 144, 192, 0.2); }
    h2, h3 { font-size: 1.8rem; color: #f06292; margin-bottom: 1rem; text-shadow: 1px 1px 2px #fce4ec; }
    h3 { font-size: 1.4rem; color: #d81b60; margin-top: 2rem; }
    form label { display: block; margin-top: 1rem; font-weight: bold; color: #ad1457; }
    form input, form select { width: 100%; padding: 0.6rem; margin-top: 0.4rem; border-radius: 8px; border: 1px solid #f8bbd0; background-color: #fff5f8; color: #ad1457; font-weight: bold; }
    input[type="radio"], input[type="checkbox"] { accent-color: #f48fb1; margin-right: 0.5rem; }
    .btn-finalizar { margin-top: 2rem; background: #f48fb1; color: white; padding: 0.8rem 1.6rem; border-radius: 10px; font-weight: bold; font-size: 1rem; border: none; cursor: pointer; transition: background 0.3s; }
    .btn-finalizar:hover { background: #ec407a; }
    .btn-volver { display: inline-block; margin-top: 1rem; color: #ec407a; text-decoration: none; font-weight: bold; font-size: 1rem; }
    .metodos-pago { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
    .metodo-pago-opcion { background: #fff5f8; padding: 1rem; border-radius: 12px; border: 2px solid #fce4ec; cursor: pointer; transition: border-color 0.3s, box-shadow 0.3s; }
    .metodo-pago-opcion:hover { border-color: #f48fb1; }
    .metodo-pago-opcion.seleccionado { border-color: #ec407a; box-shadow: 0 0 8px rgba(168, 85, 247, 0.3); }
    .metodo-pago-opcion label { display: flex; align-items: center; gap: 0.8rem; font-weight: bold; color: #ad1457; }
    .pago-detalles { display: none; margin-top: 1.5rem; padding: 1.5rem; background: #fff; border-radius: 12px; border: 1px solid #e0cce3; }
    .pago-detalles h4 { color: #f06292; margin-bottom: 1rem; }
    .pago-detalles p { margin-bottom: 1rem; }
    @media (max-width: 768px) { .checkout-container { flex-direction: column; } .formulario, .resumen { flex: 1 1 100%; } }
  </style>
</head>
<body>
  <aside class="sidebar">
    <img src="{% static 'img/logoglam.png' %}" alt="Logo GlamStore" class="logo">
    {% if request.session.usuario_nombre %}
    <a href="{% url 'perfil' %}" style="text-decoration: none; color: inherit;">
      <h1>¬°Hola, {{ request.session.usuario_nombre }}!</h1>
    </a>
    <p>Qu√© bueno verte de nuevo ‚ú®</p>
    {% else %}
    <h1>Bienvenida a GlamStore</h1>
    <p>Tu espacio de moda, color y alegr√≠a</p>
    {% endif %}
    <nav>
      <ul>
        <li><a href="{% url 'tienda' %}">‚Üê Volver a Tienda</a></li>
        {% if request.session.usuario_nombre %}
        <li><a href="{% url 'perfil' %}">Mi Perfil</a></li>
        {% else %}
        <li><a href="{% url 'login' %}">Iniciar Sesi√≥n</a></li>
        {% endif %}
        <li><a href="{% url 'ver_carrito' %}">Carrito</a></li>
      </ul>
    </nav>
  </aside>

  <main class="main-content">
    <h2 class="titulo-checkout">Finalizar Compra</h2>

    <div class="checkout-container">
      <section class="formulario">
        <form method="POST" action="{% url 'simular_pago' %}">
          {% csrf_token %}

          <h3>1. DATOS PERSONALES</h3>
          
          {% if usuario_logueado and cliente_datos %}
          <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid #4caf50;">
            <h4 style="color: #2e7d32; margin-bottom: 1rem;">‚úÖ Datos de tu cuenta</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div><strong style="color: #2e7d32;">Nombre:</strong><br><span>{{ cliente_datos.nombre }}</span></div>
              <div><strong style="color: #2e7d32;">Email:</strong><br><span>{{ cliente_datos.email }}</span></div>
              <div><strong style="color: #2e7d32;">C√©dula:</strong><br><span>{{ cliente_datos.cedula|default:"No registrada" }}</span></div>
              <div><strong style="color: #2e7d32;">Tel√©fono:</strong><br><span>{{ cliente_datos.telefono|default:"No registrado" }}</span></div>
            </div>
          </div>
          
          <input type="hidden" name="correo" value="{{ cliente_datos.email }}">
          <input type="hidden" name="nombre" value="{{ cliente_datos.nombre|slice:':20' }}">
          <input type="hidden" name="apellidos" value="{{ cliente_datos.nombre|slice:'20:' }}">
          <input type="hidden" name="documento" value="{{ cliente_datos.cedula|default:'' }}">
          <input type="hidden" name="telefono" value="{{ cliente_datos.telefono|default:'' }}">
          <input type="hidden" name="tipo_documento" value="CC">
          
          {% else %}
          <label>Correo</label>
          <input type="email" name="correo" required>

          <label>Nombre</label>
          <input type="text" name="nombre" required>

          <label>Apellidos</label>
          <input type="text" name="apellidos" required>

          <label>N√∫mero de C√©dula</label>
          <input type="text" name="documento" required placeholder="Ingresa tu n√∫mero de c√©dula">

          <label>Tel√©fono / M√≥vil</label>
          <input type="tel" name="telefono" required>
          
          <input type="hidden" name="tipo_documento" value="CC">
          {% endif %}

          <h3>2. ENTREGA</h3>
          
          <label>Departamento</label>
          <select name="departamento" id="departamento" required>
            <option value="">Selecciona tu departamento</option>
            <option value="Cundinamarca">Cundinamarca</option>
            <option value="Bogot√° D.C.">Bogot√° D.C.</option>
          </select>

          <label>Municipio</label>
          <select name="municipio" id="municipio" required>
            <option value="">Primero selecciona un departamento</option>
          </select>

          <label id="label-comuna">Comuna/Localidad</label>
          <select name="comuna" id="comuna" required>
            <option value="">Primero selecciona un municipio</option>
          </select>

          <label>Direcci√≥n</label>
          <input type="text" name="direccion" required placeholder="Ej: Calle 123 # 45-67" {% if cliente_datos.direccion %}value="{{ cliente_datos.direccion }}"{% endif %}>

          <label>Informaci√≥n adicional</label>
          <input type="text" name="info_adicional" placeholder="Ej: Apartamento 301, Torre B">

          <label>Nombre de quien recibe</label>
          <input type="text" name="nombre_receptor" required {% if cliente_datos.nombre %}value="{{ cliente_datos.nombre }}"{% endif %}>

          <h3>3. M√âTODO DE ENTREGA</h3>

          <label><input type="radio" name="pago_envio" value="ahora" checked> Pagar env√≠o ahora (Total + $10.000)</label>
          <label><input type="radio" name="pago_envio" value="contra_entrega"> Pagar env√≠o contra entrega</label>

          <h3>4. PAGO</h3>
          <div class="metodos-pago">
            <div class="metodo-pago-opcion">
              <label><input type="radio" name="metodo_pago" value="nequi_daviplata" required> üì± Pagar con Nequi / Daviplata</label>
            </div>
            <div class="metodo-pago-opcion">
              <label><input type="radio" name="metodo_pago" value="consignacion"> üè¶ Consignaci√≥n Bancaria</label>
            </div>
            <div class="metodo-pago-opcion">
              <label><input type="radio" name="metodo_pago" value="efecty"> üíµ Pago en Efecty</label>
            </div>
          </div>

          <div id="detalles_nequi_daviplata" class="pago-detalles">
            <h4>Pagar con Nequi / Daviplata</h4>
            <label for="celular_pago">N√∫mero de celular:</label>
            <input type="tel" id="celular_pago" name="celular_pago" placeholder="Tu n√∫mero de Nequi o Daviplata">
            <label for="clave_dinamica">Clave din√°mica:</label>
            <input type="text" id="clave_dinamica" name="clave_dinamica" placeholder="Ingresa tu clave din√°mica">
          </div>

          <div id="detalles_consignacion" class="pago-detalles">
            <h4>Pagar con Consignaci√≥n Bancaria</h4>
            <p>Realiza la transferencia a la siguiente cuenta:</p>
            <p><strong>Cuenta de Ahorros Bancolombia:</strong> 123-456789-00 a nombre de Glam Store.</p>
            <label for="referencia_pago">C√≥digo de referencia de pago:</label>
            <input type="text" id="referencia_pago" name="referencia_pago" placeholder="Ingresa el n√∫mero de referencia">
          </div>

          <div id="detalles_efecty" class="pago-detalles">
            <h4>Pagar en Efecty</h4>
            <p>Dir√≠gete a tu punto Efecty m√°s cercano y presenta el siguiente c√≥digo:</p>
            <p><strong>C√≥digo de pago:</strong> 987-654-321</p>
          </div>

          <button type="submit" class="btn-finalizar">Continuar y hacer el pago ‚ú®</button>
        </form>
      </section>

      <section class="resumen">
        <h2>RESUMEN DE LA COMPRA</h2>
        
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; font-size: 0.9rem;">
          <thead>
            <tr style="background-color: #f8bbd0; border-bottom: 2px solid #f48fb1;">
              <th style="padding: 0.8rem; text-align: left; color: #c2185b; font-weight: bold;">Producto</th>
              <th style="padding: 0.8rem; text-align: center; color: #c2185b; font-weight: bold;">Cantidad</th>
              <th style="padding: 0.8rem; text-align: right; color: #c2185b; font-weight: bold;">Precio Unitario</th>
              <th style="padding: 0.8rem; text-align: right; color: #c2185b; font-weight: bold;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for item in carrito %}
            <tr style="border-bottom: 1px solid #fce4ec;">
              <td style="padding: 0.8rem; color: #666;">{{ item.producto.nombreProducto }}</td>
              <td style="padding: 0.8rem; text-align: center; color: #666;">{{ item.cantidad }}</td>
              <td style="padding: 0.8rem; text-align: right; color: #666;">${{ item.producto.precio_venta|floatformat:0 }}</td>
              <td style="padding: 0.8rem; text-align: right; color: #c2185b; font-weight: bold;">${{ item.subtotal|floatformat:0 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

        <div style="background: #fffafc; padding: 1.5rem; border-radius: 10px; border: 1px solid #f8bbd0;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #fce4ec;">
            <span style="color: #666;">Sub Total:</span>
            <strong style="color: #666;" id="base-liquida-valor">${{ total|floatformat:0 }}</strong>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #fce4ec;">
            <span style="color: #666;">IVA (19%):</span>
            <strong style="color: #666;" id="iva-valor-resumen">$0</strong>
          </div>
          
          <div id="costo-envio-resumen-div" style="display: flex; justify-content: space-between; margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #fce4ec;">
            <span style="color: #666;">Env√≠o:</span>
            <strong style="color: #666;">$10.000</strong>
          </div>
          
          <div style="display: flex; justify-content: space-between; padding-top: 0.8rem;">
            <span style="font-size: 1.1rem; font-weight: bold; color: #c2185b;">Total del Pedido:</span>
            <strong style="font-size: 1.2rem; color: #ec407a;" id="total-valor-resumen">${{ total|add:10000|floatformat:0 }}</strong>
          </div>
        </div>

        <a href="{% url 'tienda' %}" class="btn-volver">‚Üê Seguir comprando</a>
      </section>
    </div>

    <footer class="pie" style="margin-top: 3rem; text-align: center; color: #888;">
      <p>&copy; 2025 GlamStore ‚Äî Belleza con estilo</p>
    </footer>
  </main>
</html>

  <script>
    const datosUbicacion = {
      'Cundinamarca': {
        municipios: ['Soacha'],
        comunas: {
          'Soacha': ['Comuna 1 - Compartir', 'Comuna 2 - La Despensa', 'Comuna 3 - Ciudad Verde', 'Comuna 4 - Cazuc√°', 'Comuna 5 - San Mateo', 'Comuna 6 - San Humberto']
        }
      },
      'Bogot√° D.C.': {
        municipios: ['Bogot√°'],
        comunas: {
          'Bogot√°': ['Usaqu√©n', 'Chapinero', 'Santa Fe', 'San Crist√≥bal', 'Usme', 'Tunjuelito', 'Bosa', 'Kennedy', 'Fontib√≥n', 'Engativ√°', 'Suba', 'Barrios Unidos', 'Teusaquillo', 'Los M√°rtires', 'Antonio Nari√±o', 'Puente Aranda', 'La Candelaria', 'Rafael Uribe Uribe', 'Ciudad Bol√≠var', 'Sumapaz']
        }
      }
    };

    document.getElementById('departamento').addEventListener('change', function () {
      const departamento = this.value;
      const municipioSelect = document.getElementById('municipio');
      const comunaSelect = document.getElementById('comuna');
      const labelComuna = document.getElementById('label-comuna');

      municipioSelect.innerHTML = '<option value="">Selecciona tu municipio</option>';
      comunaSelect.innerHTML = '<option value="">Primero selecciona un municipio</option>';

      if (departamento && datosUbicacion[departamento]) {
        datosUbicacion[departamento].municipios.forEach(municipio => {
          const option = document.createElement('option');
          option.value = municipio;
          option.textContent = municipio;
          municipioSelect.appendChild(option);
        });

        if (departamento === 'Bogot√° D.C.') {
          labelComuna.textContent = 'Localidad';
        } else {
          labelComuna.textContent = 'Comuna';
        }
      }
    });

    document.getElementById('municipio').addEventListener('change', function () {
      const departamento = document.getElementById('departamento').value;
      const municipio = this.value;
      const comunaSelect = document.getElementById('comuna');

      comunaSelect.innerHTML = '<option value="">Selecciona una opci√≥n</option>';

      if (departamento && municipio && datosUbicacion[departamento].comunas[municipio]) {
        datosUbicacion[departamento].comunas[municipio].forEach(comuna => {
          const option = document.createElement('option');
          option.value = comuna;
          option.textContent = comuna;
          comunaSelect.appendChild(option);
        });
      }
    });

    document.addEventListener('DOMContentLoaded', function () {
      const metodosPago = document.querySelectorAll('input[name="metodo_pago"]');
      const detallesPago = document.querySelectorAll('.pago-detalles');
      const opcionesPago = document.querySelectorAll('.metodo-pago-opcion');

      metodosPago.forEach(radio => {
        radio.addEventListener('change', function () {
          detallesPago.forEach(detalle => detalle.style.display = 'none');
          opcionesPago.forEach(opcion => opcion.classList.remove('seleccionado'));

          if (this.checked) {
            const idDetalle = 'detalles_' + this.value;
            const detalleSeleccionado = document.getElementById(idDetalle);
            if (detalleSeleccionado) {
              detalleSeleccionado.style.display = 'block';
              this.closest('.metodo-pago-opcion').classList.add('seleccionado');
            }
          }
        });
      });

      const radiosEnvio = document.querySelectorAll('input[name="pago_envio"]');
      const costoEnvioResumenDiv = document.getElementById('costo-envio-resumen-div');
      const totalValorResumen = document.getElementById('total-valor-resumen');
      const ivaValorResumen = document.getElementById('iva-valor-resumen');
      const baseLiquidaValor = document.getElementById('base-liquida-valor');
      const subtotal = Math.round(parseFloat('{{ total }}'));
      const costoEnvio = 10000;
      const tasaIVA = 0.19;

      function actualizarTotal() {
        const pagoAhora = document.querySelector('input[name="pago_envio"][value="ahora"]').checked;

        let subtotalConEnvio;
        if (pagoAhora) {
          costoEnvioResumenDiv.style.display = 'flex';
          subtotalConEnvio = subtotal + costoEnvio;
        } else {
          costoEnvioResumenDiv.style.display = 'none';
          subtotalConEnvio = subtotal;
        }

        const iva = Math.round(subtotal * tasaIVA);
        const totalFinal = subtotalConEnvio + iva;

        baseLiquidaValor.textContent = '$' + subtotal.toLocaleString('es-CO');
        ivaValorResumen.textContent = '$' + iva.toLocaleString('es-CO');
        totalValorResumen.textContent = '$' + totalFinal.toLocaleString('es-CO');
      }

      radiosEnvio.forEach(radio => {
        radio.addEventListener('change', actualizarTotal);
      });

      actualizarTotal();
    });
  </script>
</body>
</html>
