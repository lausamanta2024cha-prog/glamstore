{# django-html #}
<!-- htmlhint: off -->
<!-- stylelint-disable -->
{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="es"></html>
<head>
  <meta charset="UTF-8">
  <title>Panel de Administraci√≥n ‚Äî Glam Store</title>
  <link rel="icon" href="{% static 'img/logoglam.png' %}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ========================================
       BASE STYLES
       ======================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      display: flex;
      min-height: 100vh;
    }

    /* ========================================
       SIDEBAR
       ======================================== */
    .sidebar {
      background: linear-gradient(180deg, #1a1f3a 0%, #0f1419 100%);
      padding: 2rem;
      width: 240px;
      height: 100vh;
      position: fixed;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #2a3f5f;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .sidebar-logo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      box-shadow: 0 6px 20px rgba(168, 85, 247, 0.3);
      margin-bottom: 1rem;
      border: 3px solid #a855f7;
    }

    .sidebar-header h2 {
      color: #ffffff;
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .sidebar-header p {
      color: #a0aec0;
      font-size: 0.9rem;
      font-weight: 400;
      font-style: italic;
    }

    .sidebar-user {
      background-color: rgba(255, 255, 255, 0.08);
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-user p {
      margin: 0.3rem 0;
      color: #ffffff;
      font-weight: 600;
      font-size: 1rem;
    }

    .sidebar-user .rol {
      font-size: 0.85rem;
      color: #a0aec0;
      font-weight: normal;
    }

    .sidebar-nav {
      flex: 1;
    }

    .sidebar a {
      display: block;
      margin: 0.5rem 0;
      color: #cbd5e0;
      text-decoration: none;
      font-weight: 500;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border-left: 3px solid transparent;
    }

    .sidebar a::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0;
      background: rgba(168, 85, 247, 0.1);
      transition: width 0.3s ease;
      z-index: -1;
    }

    .sidebar a:hover,
    .sidebar a.active {
      color: #ffffff;
      transform: translateX(3px);
      border-left-color: #a855f7;
      background: rgba(168, 85, 247, 0.15);
    }

    .sidebar a:hover::before,
    .sidebar a.active::before {
      width: 100%;
    }

    .notification-badge {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #ef4444;
      color: white;
      border-radius: 50%;
      min-width: 22px;
      height: 22px;
      padding: 0;
      font-size: 0.75rem;
      font-weight: bold;
      margin-left: 6px;
      vertical-align: middle;
      flex-shrink: 0;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* ========================================
       MAIN CONTENT
       ======================================== */
    .main-content {
      margin-left: 240px;
      padding: 2rem 5rem;
      width: calc(100% - 240px - 10rem);
      flex: 1;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-header h1 {
      font-size: 2.2rem;
      color: #1a1a1a;
      border-bottom: 3px solid #a855f7;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .breadcrumb {
      color: #666;
      font-size: 1rem;
    }

    .breadcrumb strong {
      color: #7c3aed;
      font-weight: 600;
    }

    /* ========================================
       CARDS
       ======================================== */
    .card {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
      margin-bottom: 2rem;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(168, 85, 247, 0.2);
    }

    .card-body {
      padding: 1rem;
    }

    .card-compact {
      max-height: 300px;
      overflow-y: auto;
    }

    /* ========================================
       STATISTICS GRID
       ======================================== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #fff;
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
      text-align: center;
      transition: all 0.3s ease;
      border-top: 4px solid #a855f7;
      cursor: pointer;
      text-decoration: none;
      display: block;
      color: inherit;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(168, 85, 247, 0.2);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: #7c3aed;
      margin: 0.5rem 0;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    /* ========================================
       DASHBOARD SECTIONS - LAYOUT COMPACTO
       ======================================== */
    .dashboard-section {
      margin-bottom: 1.5rem;
    }

    .section-title {
      font-size: 1.3rem;
      color: #7c3aed;
      margin-bottom: 0.8rem;
      border-bottom: 2px solid #a855f7;
      padding-bottom: 0.3rem;
      font-weight: 600;
    }

    .dashboard-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .dashboard-row-three {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .dashboard-compact {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    /* ========================================
       CHARTS - COMPACTOS
       ======================================== */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    /* Layout especial para gr√°ficas de estad√≠sticas */
    .stats-charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .full-width-chart {
      width: 100%;
      margin: 0 -1.5rem;
      padding: 2rem;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
    }

    .chart-container {
      background: #fff;
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
      min-height: 320px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .chart-container:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(168, 85, 247, 0.15);
    }

    .chart-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #8b5cf6, #06b6d4, #10b981);
      border-radius: 15px 15px 0 0;
    }

    .chart-title {
      color: #7c3aed;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      text-align: center;
      border-bottom: 3px solid #a855f7;
      padding-bottom: 0.5rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .chart-container canvas {
      flex: 1;
      position: relative;
    }

    .chart-container select {
      width: 100%;
      padding: 0.6rem;
      border-radius: 8px;
      border: 2px solid #a855f7;
      background-color: #fff;
      color: #1a1a1a;
      font-weight: 500;
      cursor: pointer;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .chart-container select:hover {
      border-color: #7c3aed;
      box-shadow: 0 2px 8px rgba(168, 85, 247, 0.2);
    }



    /* ========================================
       PRODUCT ITEMS - COMPACTOS
       ======================================== */
    .product-item {
      display: flex;
      align-items: center;
      padding: 0.8rem 0;
      border-bottom: 1px solid #fce4ec;
      transition: all 0.3s ease;
    }

    .product-item:last-child {
      border-bottom: none;
    }

    .product-item:hover {
      background-color: #fffafc;
      padding-left: 0.5rem;
      border-radius: 8px;
    }

    .product-image {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 0.8rem;
      border: 2px solid #d8b4fe;
      transition: all 0.3s ease;
    }

    .product-image:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
    }

    .product-info {
      flex: 1;
    }

    .product-name {
      font-weight: 600;
      color: #7c3aed;
      margin-bottom: 0.2rem;
      font-size: 0.9rem;
    }

    .product-stats {
      font-size: 0.75rem;
      color: #666;
    }

    .product-actions {
      display: flex;
      gap: 0.3rem;
      align-items: center;
    }

    /* ========================================
       STOCK ITEMS - COMPACTOS
       ======================================== */
    .stock-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0;
      border-bottom: 1px solid #fce4ec;
      transition: all 0.3s ease;
    }

    .stock-item:last-child {
      border-bottom: none;
    }

    .stock-item:hover {
      background-color: #fffafc;
      padding: 0.6rem;
      border-radius: 8px;
      margin: 0 -0.6rem;
    }

    .stock-info {
      flex: 1;
    }

    .stock-name {
      font-weight: 600;
      color: #7c3aed;
      margin-bottom: 0.1rem;
      font-size: 0.9rem;
    }

    .stock-level {
      font-size: 0.75rem;
      color: #666;
    }

    .stock-actions {
      display: flex;
      gap: 0.3rem;
    }

    /* ========================================
       ORDER ITEMS
       ======================================== */
    .pedido-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      margin-bottom: 0.8rem;
      background: #faf5ff;
      border-radius: 10px;
      border-left: 4px solid #a855f7;
      transition: all 0.3s ease;
    }

    .pedido-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(168, 85, 247, 0.2);
    }

    .pedido-info {
      flex: 1;
    }

    .pedido-id {
      font-weight: 600;
      color: #7c3aed;
      margin-bottom: 0.3rem;
      font-size: 1rem;
    }

    .pedido-cliente {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
    }

    .pedido-fecha {
      font-size: 0.8rem;
      color: #999;
    }

    .pedido-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* ========================================
       BUTTONS
       ======================================== */
    .btn {
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      font-family: 'Poppins', 'Segoe UI', sans-serif;
      font-size: 1rem;
      display: inline-block;
    }

    .btn-primary {
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(168, 85, 247, 0.4);
      background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
    }

    .btn-secondary {
      background: white;
      color: #7c3aed;
      border: 2px solid #a855f7;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.2);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    .btn-stock {
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .btn-view {
      background: #e3f2fd;
      color: #1565c0;
    }

    .btn-edit {
      background: #fff3e0;
      color: #e65100;
    }

    .btn-restock {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
      color: white;
      font-weight: bold;
    }

    .btn-stock:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-restock:hover {
      background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .btn-pedido {
      padding: 0.4rem 0.8rem;
      border-radius: 15px;
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .btn-details {
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
      color: white;
    }

    .btn-details:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
    }

    /* ========================================
       BADGES
       ======================================== */
    .badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: bold;
    }

    .badge-success {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .badge-danger {
      background: #ffebee;
      color: #c62828;
    }

    .badge-warning {
      background: #fff3e0;
      color: #e65100;
    }

    .badge-fuente {
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
    }

    .fuente-excel {
      background: #e3f2fd;
      color: #1565c0;
    }

    .fuente-manual {
      background: #f3e5f5;
      color: #6a1b9a;
    }

    /* ========================================
       EMPTY STATE
       ======================================== */
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    .empty-state p {
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    /* ========================================
       RESPONSIVE DESIGN
       ======================================== */
    @media (max-width: 1400px) {
      .charts-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 1024px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .dashboard-row {
        grid-template-columns: 1fr;
      }

      .chart-container {
        min-height: 280px;
      }

      .full-width-chart {
        margin: 0;
        padding: 1.5rem;
      }

      #ventasCategoriaChart {
        height: 300px !important;
      }
    }

    @media (max-width: 768px) {
      .dashboard-row {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .chart-container {
        min-height: 250px;
      }

      #ventasCategoriaChart {
        height: 250px !important;
      }

      .full-width-chart {
        padding: 1rem;
      }
    }

    .btn-reporte:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(168, 85, 247, 0.4);
      background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }

      .main-content {
        margin-left: 0;
        padding: 2rem;
        width: 100%;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .product-item,
      .stock-item,
      .pedido-item {
        flex-direction: column;
        align-items: flex-start;
        text-align: left;
      }

      .product-image {
        margin: 0 0 1rem 0;
        align-self: center;
      }

      .product-actions,
      .stock-actions,
      .pedido-actions {
        margin-top: 1rem;
        width: 100%;
        justify-content: center;
      }

      .btn-stock,
      .btn-pedido {
        flex: 1;
        text-align: center;
      }

      .stat-number {
        font-size: 2rem;
      }

      .chart-container {
        height: 300px;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-number {
        font-size: 1.8rem;
      }

      .chart-container {
        height: 250px;
        padding: 1rem;
      }

      .product-item,
      .stock-item,
      .pedido-item {
        padding: 0.8rem;
        margin-bottom: 0.5rem;
      }
    }

    /* Estilos para tarjetas de vencimientos */
    .card-vencido {
      border-left: 5px solid #f44336;
    }

    .card-por-vencer-critico {
      border-left: 5px solid #ff9800;
    }

    .card-por-vencer {
      border-left: 5px solid #ffc107;
    }

    /* Estilos para calificaciones */
    .rating-excellent {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
    }

    .rating-good {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
    }

    .rating-poor {
      background: #ffebee;
      border-left: 4px solid #f44336;
    }

    .text-excellent {
      color: #4caf50;
    }

    .text-warning {
      color: #ff9800;
    }

    .text-danger {
      color: #f44336;
    }

    .text-success {
      color: #2e7d32;
    }

    .text-error {
      color: #c62828;
    }

    .text-muted {
      color: #666;
    }

    .text-light-muted {
      color: #999;
    }

    .text-lighter-muted {
      color: #aaa;
    }

    /* Colores de urgencia */
    .urgencia-critica {
      color: #f44336;
    }

    .urgencia-alta {
      color: #ff9800;
    }

    .urgencia-media {
      color: #ffc107;
    }

    /* Estados de pago */
    .estado-pago-completo {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .estado-pago-parcial {
      background: #fff3e0;
      color: #f57c00;
    }

    .estado-pago-pendiente {
      background: #ffebee;
      color: #c62828;
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="sidebar-header">
      <img src="{% static 'img/logoglam.png' %}" alt="Logo Glam Store" class="sidebar-logo">
      <h2>Admin Glam</h2>
      <p>Panel de Control</p>
    </div>

    <div class="sidebar-user">
      <p>{{ request.session.usuario_nombre }}</p>
      <p class="rol">{{ request.session.usuario_rol }}</p>
    </div>

        <div class="sidebar-nav">
      <a href="{% url 'dashboard_admin' %}" class="active">Dashboard</a>
      <a href="{% url 'lista_admin' %}">Mi Perfil</a>
      <a href="{% url 'notificaciones' %}">Notificaciones</a>
      <a href="{% url 'lista_clientes' %}">Clientes</a>
     <a href="{% url 'lista_distribuidores' %}">Proveedores</a>
      <a href="{% url 'lista_pedidos' %}">Pedidos</a>
      <a href="{% url 'lista_productos' %}">Productos</a>
      <a href="{% url 'lista_repartidores' %}">Repartidores</a>
      <a href="{% url 'lista_categorias' %}">Categor√≠as</a>
      <a href="{% url 'lista_subcategorias' %}">Subcategor√≠as</a>
             <a href="{% url 'reabastecimiento' %}">Reabastecimiento</a>
    </div>

    <div class="sidebar-footer">
      <a href="{% url 'logout' %}">Cerrar Sesi√≥n</a>
    </div>
  </div>

  <div class="main-content">
    <div class="page-header">
      <h1>Panel de Administraci√≥n</h1>
      <div class="breadcrumb">
        <span>Bienvenida: <strong>{{ request.session.usuario_nombre }}</strong> | Rol: <strong>Administrador</strong></span>
      </div>
    </div>

    <!-- ALERTA DE CAPACIDAD DE REPARTIDORES -->
    {% if not hay_capacidad_repartidores and pedidos_sin_asignar > 0 %}
    <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-left: 5px solid #f44336; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);">
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="font-size: 32px; font-weight: bold; color: #c62828;">!</div>
        <div style="flex: 1;">
          <h3 style="color: #c62828; margin: 0 0 5px 0; font-size: 18px;">Capacidad Limitada de Repartidores</h3>
          <p style="color: #d32f2f; margin: 0 0 10px 0; font-size: 14px;">
            Hay <strong>{{ pedidos_sin_asignar }} pedidos sin asignar</strong> pero solo <strong>{{ repartidores_disponibles }} repartidores disponibles</strong>. 
            No hay suficiente capacidad para entregar todos los pedidos hoy.
          </p>
          <p style="color: #d32f2f; margin: 0; font-size: 13px;">
            <strong>Acci√≥n recomendada:</strong> Agrega m√°s repartidores o algunos pedidos se agendar√°n para ma√±ana.
          </p>
        </div>
        <a href="{% url 'lista_repartidores' %}" style="background: #f44336; color: white; padding: 10px 20px; border-radius: 20px; text-decoration: none; font-weight: bold; white-space: nowrap; display: inline-block;">
          Ir a Repartidores
        </a>
      </div>
    </div>
    {% endif %}

    <!-- Estad√≠sticas Generales - Tiempo Real -->
    <div class="stats-grid">
      <a href="{% url 'lista_productos' %}" class="stat-card">
        <div class="stat-number">{{ total_productos }}</div>
        <div class="stat-label">Productos</div>
      </a>
      <a href="{% url 'lista_clientes' %}" class="stat-card">
        <div class="stat-number">{{ total_clientes }}</div>
        <div class="stat-label">Clientes</div>
      </a>
      <a href="{% url 'lista_pedidos' %}" class="stat-card">
        <div class="stat-number">{{ total_pedidos }}</div>
        <div class="stat-label">Pedidos</div>
      </a>
      <a href="{% url 'dashboard_admin' %}" class="stat-card">
        <div class="stat-number">${{ ventas_totales|floatformat:0|intcomma }}</div>
        <div class="stat-label">Ventas Totales</div>
      </a>
      <a href="{% url 'dashboard_admin' %}" class="stat-card" style="border-top: 4px solid #10b981;">
        <div class="stat-number" style="color: #10b981;">${{ ganancias_totales|floatformat:0|intcomma }}</div>
        <div class="stat-label">Ganancias Totales</div>
      </a>
      <a href="{% url 'notificaciones' %}" class="stat-card" style="{% if total_notificaciones_no_leidas > 0 %}border-top: 4px solid #ef4444;{% endif %}">
        <div class="stat-number" style="{% if total_notificaciones_no_leidas > 0 %}color: #ef4444;{% endif %}">{{ total_notificaciones_no_leidas }}</div>
        <div class="stat-label">Notificaciones</div>
      </a>
    </div>

    <!-- Gr√°ficos de Estad√≠sticas - Layout Reorganizado -->
    <div class="dashboard-section">
      <h2 class="section-title">
        Estad√≠sticas Semanales
        <span id="actualizacion-indicator" style="display: none; margin-left: 10px; color: #10b981; font-size: 0.8rem;">
          üîÑ Actualizando...
        </span>
      </h2>
      
      <!-- Primera fila: Dos gr√°ficas lado a lado -->
      <div class="dashboard-row" style="margin-bottom: 2rem;">
        <div class="chart-container">
          <h3 class="chart-title">Productos M√°s Vendidos</h3>
          <canvas id="productosChart" style="max-height: 280px;"></canvas>
        </div>
        <div class="chart-container">
          <h3 class="chart-title">Clientes Activos</h3>
          <canvas id="clientesChart" style="max-height: 280px;"></canvas>
        </div>
      </div>
      
      <!-- Segunda fila: Gr√°fica de ventas por categor√≠a de borde a borde -->
      <div class="chart-container" style="width: 100%; margin: 0; padding: 2rem; background: linear-gradient(135deg, #fafbff 0%, #f8fafc 100%); border: 1px solid #e2e8f0;">
        <h3 class="chart-title" style="font-size: 1.4rem; margin-bottom: 1.5rem;">Ventas por Categor√≠a</h3>
        <div id="chartLoader" style="display: flex; align-items: center; justify-content: center; height: 350px; color: #8b5cf6;">
          <div style="text-align: center;">
            <div style="font-size: 0.9rem;">Cargando gr√°fica...</div>
          </div>
        </div>
        <svg id="ventasCategoriaChart" style="width: 100%; height: 350px; margin-top: 0.5rem; display: none;"></svg>
        <div style="margin-top: 1rem; padding: 0.8rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #8b5cf6;">
          <div style="font-size: 0.8rem; color: #64748b; text-align: center;">
            <strong>Informaci√≥n:</strong> Pasa el cursor sobre los puntos para ver detalles completos de cada categor√≠a (ventas, unidades, pedidos y promedio)
          </div>
          <div id="ultima-actualizacion" style="font-size: 0.7rem; color: #9ca3af; text-align: center; margin-top: 0.5rem;">
            √öltima actualizaci√≥n: <span id="timestamp"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Reabastecimiento Reciente -->
    <div class="dashboard-section" style="margin-bottom: 2rem;">
      <h2 class="section-title" style="font-size: 1.3rem; margin-bottom: 1rem;">Reabastecimiento Reciente</h2>
      <div class="card">
        <div class="card-body card-compact">
          {% if reabastecimientos_recientes %}
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
              <thead>
                <tr style="background: #e9d5ff; border-bottom: 1px solid #a855f7;">
                  <th style="padding: 0.5rem; text-align: left; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Producto</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Cant.</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Precio Unit.</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Total IVA</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Lote</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Vencimiento</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">IVA</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Inv. Ant.</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Inv. Nuevo</th>
                  <th style="padding: 0.5rem; text-align: left; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Fuente</th>
                </tr>
              </thead>
              <tbody>
                {% for reab in reabastecimientos_recientes %}
                <tr style="border-bottom: 1px solid #e9d5ff;">
                  <td style="padding: 0.5rem; color: #1a1a1a; font-size: 0.85rem;">{{ reab.producto|truncatewords:2 }}</td>
                  <td style="padding: 0.5rem; text-align: center; color: #1a1a1a;">{{ reab.cantidad }}</td>
                  <td style="padding: 0.5rem; text-align: center; color: #1a1a1a;">{{ reab.costo_unitario|intcomma }}</td>
                  <td style="padding: 0.5rem; text-align: center; color: #2e7d32; font-weight: 600;">
                    {% if reab.total_con_iva is not None %}
                      {{ reab.total_con_iva|intcomma }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td style="padding: 0.5rem; text-align: center; color: #666; font-size: 0.8rem;">
                    {% if reab.lote %}
                      {{ reab.lote }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td style="padding: 0.5rem; text-align: center; color: #666; font-size: 0.8rem;">
                    {% if reab.fecha_vencimiento %}
                      {{ reab.fecha_vencimiento }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600;">
                    {% if reab.iva is not None %}
                      {{ reab.iva|intcomma }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td style="padding: 0.5rem; text-align: center; color: #666;">{{ reab.stock_anterior }}</td>
                  <td style="padding: 0.5rem; text-align: center; color: #2e7d32; font-weight: 600;">{{ reab.stock_nuevo }}</td>
                  <td style="padding: 0.5rem; color: #666; font-size: 0.8rem;">
                    <span class="badge-fuente {% if reab.fuente == 'Excel' %}fuente-excel{% else %}fuente-manual{% endif %}">{{ reab.fuente }}</span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p style="text-align: center; color: #999; padding: 1rem; font-size: 0.9rem;">No hay reabastecimientos en la √∫ltima semana</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Informaci√≥n de Vencimientos -->
    <div class="dashboard-section" style="margin-bottom: 2rem;">
      <h2 class="section-title" style="font-size: 1.3rem; margin-bottom: 1rem;">Control de Vencimientos</h2>
      
      <!-- Alertas de Vencimientos -->
      <div class="dashboard-row" style="margin-bottom: 1rem;">
        <!-- Productos Vencidos -->
        <div class="card {% if productos_vencidos.total_productos > 0 %}card-vencido{% endif %}">
          <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="color: #f44336; margin: 0; font-size: 1.1rem;">Productos Vencidos</h3>
              <div style="text-align: right;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #f44336;">{{ productos_vencidos.total_productos }}</div>
                <div style="font-size: 0.8rem; color: #666;">productos</div>
              </div>
            </div>
            
            {% if productos_vencidos.total_productos > 0 %}
              <div style="background: #ffebee; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                  <div>
                    <div><strong>Cantidad perdida:</strong> {{ productos_vencidos.total_cantidad }} unidades</div>
                    <div><strong>Valor perdido:</strong> ${{ productos_vencidos.total_valor|floatformat:0|intcomma }}</div>
                  </div>
                  <form action="{% url 'marcar_lotes_vencidos' %}" method="post" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" style="background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 15px; font-size: 0.8rem; cursor: pointer; font-weight: bold;">
                      Marcar como Perdidos
                    </button>
                  </form>
                </div>
              </div>
              
              <div style="max-height: 200px; overflow-y: auto;">
                {% for item in productos_vencidos.detalle %}
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #ffcdd2;">
                    <div>
                      <div style="font-weight: bold; color: #c62828; font-size: 0.9rem;">{{ item.producto.nombreProducto }}</div>
                      <div style="font-size: 0.75rem; color: #666;">
                        Lote: {{ item.lote.codigo_lote }} | Vencido hace {{ item.dias_vencido }} d√≠as
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-weight: bold; color: #f44336;">{{ item.cantidad_perdida }} unidades</div>
                      <div style="font-size: 0.75rem; color: #666;">${{ item.valor_perdido|floatformat:0|intcomma }}</div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p style="color: #4caf50; text-align: center; margin: 0; font-size: 0.9rem;">No hay productos vencidos</p>
            {% endif %}
          </div>
        </div>

        <!-- Productos por Vencer -->
        <div class="card {% if productos_por_vencer.criticos > 0 %}card-por-vencer-critico{% elif productos_por_vencer.total_productos > 0 %}card-por-vencer{% endif %}">
          <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="color: #ff9800; margin: 0; font-size: 1.1rem;">Por Vencer (30 d√≠as)</h3>
              <div style="text-align: right;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #ff9800;">{{ productos_por_vencer.total_productos }}</div>
                <div style="font-size: 0.8rem; color: #666;">productos</div>
              </div>
            </div>
            
            {% if productos_por_vencer.total_productos > 0 %}
              <div style="background: #fff3e0; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.5rem;">
                  <span><strong>Cantidad en riesgo:</strong> {{ productos_por_vencer.total_cantidad }} unidades</span>
                  <span><strong>Valor en riesgo:</strong> ${{ productos_por_vencer.total_valor|floatformat:0|intcomma }}</span>
                </div>
                <div style="display: flex; gap: 1rem; font-size: 0.8rem;">
                  <span style="color: #f44336;"><strong>Cr√≠ticos (‚â§7 d√≠as):</strong> {{ productos_por_vencer.criticos }}</span>
                  <span style="color: #ff9800;"><strong>Altos (‚â§15 d√≠as):</strong> {{ productos_por_vencer.altos }}</span>
                  <span style="color: #ffc107;"><strong>Medios (‚â§30 d√≠as):</strong> {{ productos_por_vencer.medios }}</span>
                </div>
              </div>
              
              <div style="max-height: 200px; overflow-y: auto;">
                {% for item in productos_por_vencer.detalle %}
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #ffcc02;">
                    <div>
                      <div class="{% if item.urgencia == 'critica' %}urgencia-critica{% elif item.urgencia == 'alta' %}urgencia-alta{% else %}urgencia-media{% endif %}" style="font-weight: bold; font-size: 0.9rem;">
                        {{ item.producto.nombreProducto }}
                      </div>
                      <div style="font-size: 0.75rem; color: #666;">
                        Lote: {{ item.lote.codigo_lote }} | Vence: {{ item.fecha_vencimiento|date:"d/m/Y" }}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div class="{% if item.urgencia == 'critica' %}urgencia-critica{% elif item.urgencia == 'alta' %}urgencia-alta{% else %}urgencia-media{% endif %}" style="font-weight: bold;">
                        {{ item.dias_restantes }} d√≠as
                      </div>
                      <div style="font-size: 0.75rem; color: #666;">{{ item.cantidad_disponible }} unidades</div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p style="color: #4caf50; text-align: center; margin: 0; font-size: 0.9rem;">No hay productos pr√≥ximos a vencer</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Pedidos Nuevos por Asignar Repartidor -->
    <div class="dashboard-section" style="margin-bottom: 2rem;">
      <h2 class="section-title" style="font-size: 1.3rem; margin-bottom: 1rem;">Pedidos Nuevos por Asignar Repartidor</h2>
      <div class="card">
        <div class="card-body card-compact">
          {% if pedidos_por_asignar %}
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
              <thead>
                <tr style="background: #e9d5ff; border-bottom: 1px solid #a855f7;">
                  <th style="padding: 0.5rem; text-align: left; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">#Pedido</th>
                  <th style="padding: 0.5rem; text-align: left; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Cliente</th>
                  <th style="padding: 0.5rem; text-align: left; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Direcci√≥n</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Total</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Estado Pago</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Fecha</th>
                  <th style="padding: 0.5rem; text-align: center; color: #7c3aed; font-weight: 600; font-size: 0.8rem;">Acci√≥n</th>
                </tr>
              </thead>
              <tbody>
                {% for pedido in pedidos_por_asignar %}
                <tr style="border-bottom: 1px solid #e9d5ff;">
                  <td style="padding: 0.5rem; color: #1a1a1a; font-weight: 600;">#{{ pedido.idPedido }}</td>
                  <td style="padding: 0.5rem; color: #1a1a1a;">{{ pedido.idCliente.nombre|truncatewords:3 }}</td>
                  <td style="padding: 0.5rem; color: #666; font-size: 0.8rem;">{{ pedido.idCliente.direccion|truncatewords:5 }}</td>
                  <td style="padding: 0.5rem; text-align: center; color: #2e7d32; font-weight: 600;">${{ pedido.total|floatformat:0|intcomma }}</td>
                  <td style="padding: 0.5rem; text-align: center;">
                    <span class="{% if pedido.estado_pago == 'Pago Completo' %}estado-pago-completo{% elif pedido.estado_pago == 'Pago Parcial' %}estado-pago-parcial{% else %}estado-pago-pendiente{% endif %}" style="padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.75rem; font-weight: bold;">
                      {{ pedido.estado_pago }}
                    </span>
                  </td>
                  <td style="padding: 0.5rem; text-align: center; color: #666; font-size: 0.8rem;">{{ pedido.fechaCreacion|date:"d/m/Y H:i" }}</td>
                  <td style="padding: 0.5rem; text-align: center;">
                    <a href="{% url 'lista_repartidores' %}" 
                       style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); 
                              color: white; padding: 0.3rem 0.8rem; border-radius: 15px; 
                              text-decoration: none; font-size: 0.75rem; font-weight: 600;
                              display: inline-block; transition: all 0.3s ease;">
                      Asignar
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p style="text-align: center; color: #999; padding: 1rem; font-size: 0.9rem;">No hay pedidos pendientes por asignar repartidor</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Layout Horizontal: Inventario Bajo, Productos Vendidos y Pedidos -->
    <div class="dashboard-row-three">
      <div class="dashboard-section">
        <h2 class="section-title">Inventario Bajo</h2>
        <div class="card">
          <div class="card-body card-compact">
            {% for producto in productos_por_surtir %}
              <div class="stock-item">
                <div class="stock-info">
                  <div class="stock-name">{{ producto.nombreProducto }}</div>
                  <div class="stock-level">
                    Inventario: <strong style="color: #c62828;">{{ producto.stock }}</strong>
                    {% if producto.stock == 0 %}
                      <span class="badge badge-danger">Agotado</span>
                    {% elif producto.stock <= 5 %}
                      <span class="badge badge-warning">Cr√≠tico</span>
                    {% endif %}
                  </div>
                </div>
                <div class="stock-actions">
                  <a href="{% url 'movimientos_producto' producto.idProducto %}" class="btn-stock btn-restock">Reabastecer</a>
                </div>
              </div>
            {% empty %}
              <div class="empty-state">
                <p>Inventario suficiente</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="dashboard-section">
        <h2 class="section-title">Productos M√°s Vendidos</h2>
        <div class="card">
          <div class="card-body card-compact">
            {% for producto in productos_mas_vendidos %}
              <div class="product-item">
                {% if producto.imagen %}
                  <img src="{{ producto.imagen.url }}" alt="{{ producto.nombreProducto }}" class="product-image">
                {% else %}
                  <div class="product-image" style="background: #f8bbd0; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                    {{ producto.nombreProducto|first }}
                  </div>
                {% endif %}
                <div class="product-info">
                  <div class="product-name">{{ producto.nombreProducto }}</div>
                  <div class="product-stats">
                    <strong>{{ producto.total_vendido }}</strong> | {{ producto.ultima_venta|date:"d/m/Y" }}
                  </div>
                </div>
                <div class="product-actions">
                  <a href="{% url 'producto_detalle' producto.idProducto %}" class="btn btn-secondary btn-small">Ver</a>
                </div>
              </div>
            {% empty %}
              <div class="empty-state">
                <p>Sin datos de ventas</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="dashboard-section">
        <h2 class="section-title">Pedidos Recientes</h2>
        <div class="card">
          <div class="card-body card-compact">
            {% for pedido in pedidos_nuevos %}
              <div class="pedido-item">
                <div class="pedido-info">
                  <div class="pedido-id">Pedido #{{ pedido.idPedido }}</div>
                  <div class="pedido-cliente">{{ pedido.idCliente.nombre }}</div>
                  <div class="pedido-fecha">{{ pedido.fechaCreacion|date:"d/m/Y" }} | ${{ pedido.total }}</div>
                </div>
                <div class="pedido-actions">
                  <a href="{% url 'detalle_pedido' pedido.idPedido %}" class="btn-pedido btn-details">Ver</a>
                </div>
              </div>
            {% empty %}
              <div class="empty-state">
                <p>Sin pedidos recientes</p>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Calificaciones de Repartidores -->
    <div class="dashboard-row" style="margin-top: 2rem;">
      <!-- Repartidor Estrella del Mes -->
      <div class="dashboard-section">
        <h2 class="section-title">Repartidor Estrella del Mes</h2>
        <div class="card">
          <div class="card-body" style="text-align: center; padding: 2rem;">
            {% if repartidor_estrella %}
            <div style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);">
              <div style="font-size: 1rem; color: #fff; margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 2px;">Estrella del Mes</div>
              <div style="font-size: 1.6rem; font-weight: bold; color: #fff;">{{ repartidor_estrella.repartidor__nombreRepartidor }}</div>
            </div>
            <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 1rem;">
              <div style="background: #fffafc; padding: 1rem 1.5rem; border-radius: 10px; border: 2px solid #ffc107;">
                <div style="color: #ffc107; font-size: 1.3rem; margin-bottom: 0.3rem;">
                  {% with promedio=repartidor_estrella.promedio_calificacion|floatformat:0|add:0 %}
                    {% for i in "12345" %}{% if forloop.counter <= promedio %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}
                  {% endwith %}
                </div>
                <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">{{ repartidor_estrella.promedio_calificacion|floatformat:1 }}</div>
                <div style="color: #666; font-size: 0.85rem;">Promedio</div>
              </div>
              <div style="background: #faf5ff; padding: 1rem 1.5rem; border-radius: 10px; border: 2px solid #7c3aed;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;">{{ repartidor_estrella.total_entregas }}</div>
                <div style="color: #666; font-size: 0.85rem;">Entregas</div>
              </div>
            </div>
            {% else %}
            <div class="empty-state">
              <p>Sin calificaciones este mes</p>
              <p style="font-size: 0.85rem; color: #999;">Las calificaciones aparecer√°n cuando los clientes confirmen sus entregas</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Calificaciones Recientes -->
      <div class="dashboard-section">
        <h2 class="section-title">Calificaciones de Entregas Confirmadas</h2>
        <div class="card">
          <div class="card-body card-compact">
            {% for calif in calificaciones_recientes %}
            <div class="{% if calif.calificacion >= 4 %}rating-excellent{% elif calif.calificacion >= 3 %}rating-good{% else %}rating-poor{% endif %}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; margin-bottom: 0.5rem; border-radius: 10px;">
              <div>
                <div style="font-weight: bold; color: #c2185b;">Pedido #{{ calif.pedido.idPedido }}</div>
                <div style="font-size: 0.85rem; color: #666;">
                  <strong>Repartidor:</strong> {% if calif.repartidor %}{{ calif.repartidor.nombreRepartidor }}{% else %}Sin asignar{% endif %}
                </div>
                <div style="font-size: 0.8rem; color: #999;">
                  <strong>Cliente:</strong> {{ calif.pedido.idCliente.nombre|default:"N/A" }}
                </div>
                <div style="font-size: 0.75rem; color: #aaa;">{{ calif.fecha_confirmacion|date:"d/m/Y H:i" }}</div>
              </div>
              <div style="text-align: right;">
                <div style="color: #ffc107; font-size: 1.4rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
                  {% for i in "12345" %}
                    {% if forloop.counter <= calif.calificacion %}‚òÖ{% else %}‚òÜ{% endif %}
                  {% endfor %}
                </div>
                <div class="{% if calif.calificacion >= 4 %}text-excellent{% elif calif.calificacion >= 3 %}text-warning{% else %}text-danger{% endif %}" style="font-size: 0.9rem; font-weight: bold;">
                  {{ calif.calificacion }}/5
                </div>
                {% if calif.comentario %}
                <div style="font-size: 0.75rem; color: #666; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 0.3rem;" title="{{ calif.comentario }}">{{ calif.comentario|truncatewords:5 }}</div>
                {% endif %}
              </div>
            </div>
            {% empty %}
            <div class="empty-state">
              <p>Sin calificaciones registradas</p>
              <p style="font-size: 0.85rem; color: #999;">Las calificaciones aparecer√°n cuando los clientes confirmen la recepci√≥n de sus pedidos</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* stylelint-disable */
    /* eslint-disable */
    // Datos para los gr√°ficos - Generados por Django
    const productosData = {
      labels: [
        {% for producto in productos_mas_vendidos %}'{{ producto.nombreProducto|truncatechars:15 }}'{% if not forloop.last %},{% endif %}{% endfor %}
      ],
      datasets: [{
        label: 'Unidades Vendidas',
        data: [
          {% for producto in productos_mas_vendidos %}{{ producto.total_vendido }}{% if not forloop.last %},{% endif %}{% endfor %}
        ],
        backgroundColor: [
          '#a855f7',  // P√∫rpura vibrante
          '#3b82f6',  // Azul brillante
          '#10b981',  // Verde esmeralda
          '#f59e0b',  // Naranja dorado
          '#ef4444'   // Rojo coral
        ],
        borderColor: '#fff',
        borderWidth: 3
      }]
    };

    const clientesData = {
      labels: ['Hace 2 Semanas', 'Semana Pasada', 'Esta Semana'],
      datasets: [{
        label: 'Clientes Activos (con Pedidos)',
        data: [{{ clientes_hace_2_semanas }}, {{ clientes_semana_pasada }}, {{ clientes_esta_semana }}],
        backgroundColor: [
          '#8b5cf6',  // P√∫rpura medio
          '#10b981',  // Verde
          '#06b6d4'   // Cyan brillante
        ],
        borderColor: [
          '#7c3aed',
          '#059669',
          '#0891b2'
        ],
        borderWidth: 2,
        borderRadius: 8,
        borderSkipped: false
      }]
    };

    const ventasCategoriaData = {
      labels: [
        {% for categoria in ventas_por_categoria %}'{{ categoria.categoria }}'{% if not forloop.last %},{% endif %}{% endfor %}
      ],
      data: [
        {% for categoria in ventas_por_categoria %}{{ categoria.total }}{% if not forloop.last %},{% endif %}{% endfor %}
      ],
      detalles: [
        {% for categoria in ventas_por_categoria %}{
          categoria: '{{ categoria.categoria }}',
          total: {{ categoria.total }},
          cantidad_vendida: {{ categoria.cantidad_vendida }},
          num_pedidos: {{ categoria.num_pedidos }},
          num_productos: {{ categoria.num_productos }},
          promedio_por_pedido: {{ categoria.promedio_por_pedido|floatformat:0 }}
        }{% if not forloop.last %},{% endif %}{% endfor %}
      ]
    };



    const chartOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true
          }
        }
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Actualizar timestamp inicial
      actualizarTimestamp();
      // Gr√°fico de productos m√°s vendidos (esta semana)
      const productosCtx = document.getElementById('productosChart');
      if (productosCtx && productosData.labels.length > 0) {
        new Chart(productosCtx.getContext('2d'), {
          type: 'doughnut',
          data: productosData,
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 15,
                  usePointStyle: true,
                  font: { size: 11, family: 'Poppins' }
                }
              },
              tooltip: {
                backgroundColor: '#1f2937',
                titleColor: '#ffffff',
                bodyColor: '#d1d5db',
                borderColor: '#8b5cf6',
                borderWidth: 2,
                cornerRadius: 8,
                titleFont: { family: 'Poppins', weight: 'bold' },
                bodyFont: { family: 'Poppins' },
                callbacks: {
                  label: function(context) {
                    return `${context.label}: ${context.parsed} unidades`;
                  }
                }
              }
            }
          }
        });
      } else if (productosCtx) {
        productosCtx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #9ca3af; flex-direction: column;"><div>Sin ventas esta semana</div><div style="font-size: 0.8rem; margin-top: 0.5rem;">Los productos aparecer√°n cuando se registren ventas</div></div>';
      }

      // Gr√°fico de clientes nuevos por semana
      const clientesCtx = document.getElementById('clientesChart');
      if (clientesCtx) {
        new Chart(clientesCtx.getContext('2d'), {
          type: 'bar',
          data: clientesData,
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 15,
                  usePointStyle: true,
                  font: { size: 11, family: 'Poppins' }
                }
              },
              tooltip: {
                backgroundColor: '#1f2937',
                titleColor: '#ffffff',
                bodyColor: '#d1d5db',
                borderColor: '#06b6d4',
                borderWidth: 2,
                cornerRadius: 8,
                titleFont: { family: 'Poppins', weight: 'bold' },
                bodyFont: { family: 'Poppins' },
                callbacks: {
                  label: function(context) {
                    return `${context.parsed.y} clientes activos`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'N√∫mero de Clientes',
                  font: { family: 'Poppins', weight: 'bold' },
                  color: '#374151'
                },
                ticks: {
                  stepSize: 1,
                  font: { size: 10, family: 'Poppins' },
                  color: '#6b7280'
                },
                grid: {
                  color: '#e5e7eb'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Per√≠odo',
                  font: { family: 'Poppins', weight: 'bold' },
                  color: '#374151'
                },
                ticks: {
                  font: { size: 9, family: 'Poppins' },
                  color: '#6b7280',
                  maxRotation: 45
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      // Gr√°fico de ventas por categor√≠a (L√≠nea mejorada con m√°s detalles)
      const svg = document.getElementById('ventasCategoriaChart');
      const loader = document.getElementById('chartLoader');
      
      if (svg && ventasCategoriaData.labels.length > 0) {
        // Ocultar loader y mostrar gr√°fica
        if (loader) loader.style.display = 'none';
        svg.style.display = 'block';
        const datos = ventasCategoriaData.data;
        const categorias = ventasCategoriaData.labels;
        
        // Asegurar que tenemos datos v√°lidos
        if (datos.length === 0 || categorias.length === 0) {
          svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#999">No hay categor√≠as disponibles</text>';
          return;
        }
        
        // Filtrar datos para mostrar solo categor√≠as con al menos alg√∫n producto
        const datosValidos = [];
        const categoriasValidas = [];
        const detallesValidos = [];
        
        for (let i = 0; i < datos.length; i++) {
          if (ventasCategoriaData.detalles[i] && ventasCategoriaData.detalles[i].num_productos > 0) {
            datosValidos.push(datos[i]);
            categoriasValidas.push(categorias[i]);
            detallesValidos.push(ventasCategoriaData.detalles[i]);
          }
        }
        
        // Usar los datos filtrados
        const datosFinales = datosValidos.length > 0 ? datosValidos : datos;
        const categoriasFinales = categoriasValidas.length > 0 ? categoriasValidas : categorias;
        const detallesFinales = detallesValidos.length > 0 ? detallesValidos : ventasCategoriaData.detalles;
        
        // Dimensiones optimizadas para layout de borde a borde
        const width = 1000;
        const height = 350;
        const padding = { top: 50, right: 80, bottom: 120, left: 140 };
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;
        
        // Configurar SVG
        svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
        svg.style.width = '100%';
        svg.style.height = '350px';
        
        // Encontrar m√°ximo y m√≠nimo valor con mejor margen
        const maxValor = Math.max(...datosFinales) * 1.15; // 15% de margen superior
        const minValor = Math.max(0, Math.min(...datosFinales) * 0.9); // 10% de margen inferior, m√≠nimo 0
        
        // Escalas mejoradas
        const escalaY = chartHeight / (maxValor - minValor);
        const escalaX = categoriasFinales.length > 1 ? chartWidth / (categoriasFinales.length - 1) : chartWidth / 2;
        
        // Limpiar SVG
        svg.innerHTML = '';
        
        // Crear grupo principal
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('transform', `translate(${padding.left}, ${padding.top})`);
        
        // Gradiente para el √°rea bajo la l√≠nea
        const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', 'areaGradient');
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '0%');
        gradient.setAttribute('y2', '100%');
        
        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('stop-color', '#8b5cf6');
        stop1.setAttribute('stop-opacity', '0.3');
        
        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('stop-color', '#8b5cf6');
        stop2.setAttribute('stop-opacity', '0.05');
        
        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        defs.appendChild(gradient);
        svg.appendChild(defs);
        
        // Dibujar l√≠neas de cuadr√≠cula mejoradas
        const numLineas = 6;
        for (let i = 0; i <= numLineas; i++) {
          const y = (chartHeight / numLineas) * i;
          const valor = maxValor - ((maxValor - minValor) / numLineas) * i;
          
          // L√≠nea horizontal de cuadr√≠cula
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', 0);
          line.setAttribute('y1', y);
          line.setAttribute('x2', chartWidth);
          line.setAttribute('y2', y);
          line.setAttribute('stroke', i === numLineas ? '#374151' : '#e5e7eb');
          line.setAttribute('stroke-width', i === numLineas ? 2 : 1);
          line.setAttribute('stroke-dasharray', i === numLineas ? 'none' : '3,3');
          g.appendChild(line);
          
          // Etiqueta Y (valores de ventas) mejorada
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', -20);
          text.setAttribute('y', y + 5);
          text.setAttribute('text-anchor', 'end');
          text.setAttribute('font-size', '12');
          text.setAttribute('fill', '#4b5563');
          text.setAttribute('font-family', 'Poppins, Arial, sans-serif');
          text.setAttribute('font-weight', '500');
          
          // Formatear valor como moneda colombiana
          const valorFormateado = new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
            notation: valor >= 1000000 ? 'compact' : 'standard'
          }).format(Math.round(valor));
          
          text.textContent = valorFormateado;
          g.appendChild(text);
        }
        
        // Dibujar l√≠neas verticales de cuadr√≠cula para cada categor√≠a
        categoriasFinales.forEach((categoria, index) => {
          const x = categoriasFinales.length === 1 ? chartWidth / 2 : escalaX * index;
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', x);
          line.setAttribute('y1', 0);
          line.setAttribute('x2', x);
          line.setAttribute('y2', chartHeight);
          line.setAttribute('stroke', '#f3f4f6');
          line.setAttribute('stroke-width', 1);
          line.setAttribute('stroke-dasharray', '2,4');
          g.appendChild(line);
        });
        
        // Dibujar ejes principales
        const ejeY = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        ejeY.setAttribute('x1', 0);
        ejeY.setAttribute('y1', 0);
        ejeY.setAttribute('x2', 0);
        ejeY.setAttribute('y2', chartHeight);
        ejeY.setAttribute('stroke', '#374151');
        ejeY.setAttribute('stroke-width', 3);
        g.appendChild(ejeY);
        
        const ejeX = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        ejeX.setAttribute('x1', 0);
        ejeX.setAttribute('y1', chartHeight);
        ejeX.setAttribute('x2', chartWidth);
        ejeX.setAttribute('y2', chartHeight);
        ejeX.setAttribute('stroke', '#374151');
        ejeX.setAttribute('stroke-width', 3);
        g.appendChild(ejeX);
        
        // Crear puntos para la l√≠nea con informaci√≥n detallada
        const puntos = datosFinales.map((valor, index) => {
          // Distribuir puntos uniformemente, incluso si hay solo una categor√≠a
          const x = categoriasFinales.length === 1 ? chartWidth / 2 : (chartWidth / (categoriasFinales.length - 1)) * index;
          const y = chartHeight - ((valor - minValor) * escalaY);
          const detalle = detallesFinales[index] || {};
          return { 
            x, 
            y, 
            valor, 
            categoria: categoriasFinales[index],
            cantidad_vendida: detalle.cantidad_vendida || 0,
            num_pedidos: detalle.num_pedidos || 0,
            num_productos: detalle.num_productos || 0,
            promedio_por_pedido: detalle.promedio_por_pedido || 0
          };
        });
        
        // Dibujar √°rea bajo la l√≠nea
        if (puntos.length > 1) {
          let areaPath = `M 0 ${chartHeight}`;
          puntos.forEach((punto, index) => {
            if (index === 0) {
              areaPath += ` L ${punto.x} ${punto.y}`;
            } else {
              areaPath += ` L ${punto.x} ${punto.y}`;
            }
          });
          areaPath += ` L ${puntos[puntos.length - 1].x} ${chartHeight} Z`;
          
          const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          area.setAttribute('d', areaPath);
          area.setAttribute('fill', 'url(#areaGradient)');
          g.appendChild(area);
        }
        
        // Dibujar l√≠nea principal con curvas suaves
        if (puntos.length > 1) {
          let pathData = `M ${puntos[0].x} ${puntos[0].y}`;
          
          for (let i = 1; i < puntos.length; i++) {
            // Crear curvas suaves entre puntos
            const prevPunto = puntos[i - 1];
            const currentPunto = puntos[i];
            const controlX = (prevPunto.x + currentPunto.x) / 2;
            
            pathData += ` Q ${controlX} ${prevPunto.y} ${currentPunto.x} ${currentPunto.y}`;
          }
          
          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('d', pathData);
          path.setAttribute('stroke', '#8b5cf6');
          path.setAttribute('stroke-width', 4);
          path.setAttribute('fill', 'none');
          path.setAttribute('stroke-linecap', 'round');
          path.setAttribute('stroke-linejoin', 'round');
          path.style.filter = 'drop-shadow(0 2px 4px rgba(139, 92, 246, 0.3))';
          g.appendChild(path);
        }
        
        // Dibujar puntos mejorados con animaciones
        puntos.forEach((punto, index) => {
          // C√≠rculo exterior (sombra)
          const outerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          outerCircle.setAttribute('cx', punto.x);
          outerCircle.setAttribute('cy', punto.y);
          outerCircle.setAttribute('r', 8);
          outerCircle.setAttribute('fill', '#8b5cf6');
          outerCircle.setAttribute('opacity', '0.2');
          g.appendChild(outerCircle);
          
          // C√≠rculo principal
          const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          circle.setAttribute('cx', punto.x);
          circle.setAttribute('cy', punto.y);
          circle.setAttribute('r', 6);
          circle.setAttribute('fill', '#8b5cf6');
          circle.setAttribute('stroke', '#ffffff');
          circle.setAttribute('stroke-width', 3);
          circle.style.cursor = 'pointer';
          circle.style.filter = 'drop-shadow(0 2px 6px rgba(139, 92, 246, 0.4))';
          
          // Efectos hover mejorados
          circle.addEventListener('mouseover', function() {
            circle.setAttribute('r', 9);
            circle.setAttribute('fill', '#7c3aed');
            outerCircle.setAttribute('r', 12);
            outerCircle.setAttribute('opacity', '0.3');
            
            // Tooltip detallado mejorado
            const tooltip = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            tooltip.setAttribute('id', 'tooltip-' + index);
            
            // Fondo del tooltip m√°s grande para m√°s informaci√≥n
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', punto.x - 100);
            rect.setAttribute('y', punto.y - 85);
            rect.setAttribute('width', 200);
            rect.setAttribute('height', 75);
            rect.setAttribute('fill', '#1f2937');
            rect.setAttribute('rx', 10);
            rect.setAttribute('ry', 10);
            rect.style.filter = 'drop-shadow(0 6px 20px rgba(0, 0, 0, 0.4))';
            tooltip.appendChild(rect);
            
            // T√≠tulo de categor√≠a
            const textCategoria = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textCategoria.setAttribute('x', punto.x);
            textCategoria.setAttribute('y', punto.y - 65);
            textCategoria.setAttribute('text-anchor', 'middle');
            textCategoria.setAttribute('font-size', '12');
            textCategoria.setAttribute('fill', '#8b5cf6');
            textCategoria.setAttribute('font-family', 'Poppins, Arial, sans-serif');
            textCategoria.setAttribute('font-weight', 'bold');
            textCategoria.textContent = punto.categoria;
            tooltip.appendChild(textCategoria);
            
            // Ventas totales
            const textVentas = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textVentas.setAttribute('x', punto.x);
            textVentas.setAttribute('y', punto.y - 48);
            textVentas.setAttribute('text-anchor', 'middle');
            textVentas.setAttribute('font-size', '11');
            textVentas.setAttribute('fill', '#ffffff');
            textVentas.setAttribute('font-family', 'Poppins, Arial, sans-serif');
            textVentas.setAttribute('font-weight', 'bold');
            
            const valorFormateado = new Intl.NumberFormat('es-CO', {
              style: 'currency',
              currency: 'COP',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
            }).format(punto.valor);
            
            textVentas.textContent = valorFormateado;
            tooltip.appendChild(textVentas);
            
            // Informaci√≥n adicional l√≠nea 1
            const textInfo1 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textInfo1.setAttribute('x', punto.x);
            textInfo1.setAttribute('y', punto.y - 32);
            textInfo1.setAttribute('text-anchor', 'middle');
            textInfo1.setAttribute('font-size', '9');
            textInfo1.setAttribute('fill', '#d1d5db');
            textInfo1.setAttribute('font-family', 'Poppins, Arial, sans-serif');
            textInfo1.textContent = `${punto.cantidad_vendida} unidades ‚Ä¢ ${punto.num_pedidos} pedidos`;
            tooltip.appendChild(textInfo1);
            
            // Informaci√≥n adicional l√≠nea 2
            const textInfo2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textInfo2.setAttribute('x', punto.x);
            textInfo2.setAttribute('y', punto.y - 20);
            textInfo2.setAttribute('text-anchor', 'middle');
            textInfo2.setAttribute('font-size', '9');
            textInfo2.setAttribute('fill', '#d1d5db');
            textInfo2.setAttribute('font-family', 'Poppins, Arial, sans-serif');
            
            const promedioFormateado = new Intl.NumberFormat('es-CO', {
              style: 'currency',
              currency: 'COP',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
            }).format(punto.promedio_por_pedido);
            
            textInfo2.textContent = `${punto.num_productos} productos ‚Ä¢ ${promedioFormateado}/pedido`;
            tooltip.appendChild(textInfo2);
            
            g.appendChild(tooltip);
          });
          
          circle.addEventListener('mouseout', function() {
            circle.setAttribute('r', 6);
            circle.setAttribute('fill', '#8b5cf6');
            outerCircle.setAttribute('r', 8);
            outerCircle.setAttribute('opacity', '0.2');
            
            const tooltip = document.getElementById('tooltip-' + index);
            if (tooltip) {
              tooltip.remove();
            }
          });
          
          g.appendChild(circle);
          
          // Etiqueta X mejorada (nombre de categor√≠a)
          const textX = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          textX.setAttribute('x', punto.x);
          textX.setAttribute('y', chartHeight + 25);
          textX.setAttribute('text-anchor', 'middle');
          textX.setAttribute('font-size', '12');
          textX.setAttribute('fill', '#374151');
          textX.setAttribute('font-family', 'Poppins, Arial, sans-serif');
          textX.setAttribute('font-weight', '600');
          
          // Truncar texto si es muy largo
          let textoCategoria = punto.categoria;
          if (textoCategoria.length > 15) {
            textoCategoria = textoCategoria.substring(0, 13) + '...';
          }
          textX.textContent = textoCategoria;
          g.appendChild(textX);
          
          // Valor debajo de cada punto
          const valorText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          valorText.setAttribute('x', punto.x);
          valorText.setAttribute('y', chartHeight + 45);
          valorText.setAttribute('text-anchor', 'middle');
          valorText.setAttribute('font-size', '10');
          valorText.setAttribute('fill', '#8b5cf6');
          valorText.setAttribute('font-family', 'Poppins, Arial, sans-serif');
          valorText.setAttribute('font-weight', 'bold');
          
          const valorCompacto = new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
            notation: 'compact'
          }).format(punto.valor);
          
          valorText.textContent = valorCompacto;
          g.appendChild(valorText);
        });
        
        // Etiquetas de ejes mejoradas
        const labelY = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        labelY.setAttribute('transform', `rotate(-90)`);
        labelY.setAttribute('y', -80);
        labelY.setAttribute('x', -chartHeight / 2);
        labelY.setAttribute('text-anchor', 'middle');
        labelY.setAttribute('font-size', '14');
        labelY.setAttribute('fill', '#374151');
        labelY.setAttribute('font-weight', 'bold');
        labelY.setAttribute('font-family', 'Poppins, Arial, sans-serif');
        labelY.textContent = 'Ventas Totales (COP)';
        g.appendChild(labelY);
        
        const labelX = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        labelX.setAttribute('x', chartWidth / 2);
        labelX.setAttribute('y', chartHeight + 75);
        labelX.setAttribute('text-anchor', 'middle');
        labelX.setAttribute('font-size', '14');
        labelX.setAttribute('fill', '#374151');
        labelX.setAttribute('font-weight', 'bold');
        labelX.setAttribute('font-family', 'Poppins, Arial, sans-serif');
        labelX.textContent = 'Categor√≠as de Productos';
        g.appendChild(labelX);
        
        svg.appendChild(g);
      } else if (svg) {
        // Ocultar loader y mostrar mensaje cuando no hay datos
        if (loader) loader.style.display = 'none';
        svg.style.display = 'block';
        svg.innerHTML = `
          <g transform="translate(50, 50)">
            <rect x="0" y="0" width="500" height="150" fill="#f9fafb" stroke="#e5e7eb" stroke-width="2" rx="10"/>
            <text x="250" y="80" text-anchor="middle" font-size="16" fill="#6b7280" font-family="Poppins, Arial, sans-serif" font-weight="500">
              Sin datos de ventas por categor√≠a
            </text>
            <text x="250" y="105" text-anchor="middle" font-size="12" fill="#9ca3af" font-family="Poppins, Arial, sans-serif">
              Los datos aparecer√°n cuando se registren ventas en la √∫ltima semana
            </text>
          </g>
        `;
      }
    });

    // Variables globales para las gr√°ficas
    let productosChartInstance = null;
    let clientesChartInstance = null;

    // Funci√≥n para actualizar el timestamp
    function actualizarTimestamp() {
      const timestampElement = document.getElementById('timestamp');
      if (timestampElement) {
        const ahora = new Date();
        const opciones = { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit' 
        };
        timestampElement.textContent = ahora.toLocaleDateString('es-CO', opciones);
      }
    }

    // Funci√≥n para actualizar datos via AJAX
    async function actualizarDatosGraficas() {
      const indicator = document.getElementById('actualizacion-indicator');
      
      try {
        // Mostrar indicador de actualizaci√≥n
        if (indicator) {
          indicator.style.display = 'inline';
        }
        
        const response = await fetch(window.location.href, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
          }
        });
        
        if (response.ok) {
          // Actualizar timestamp antes de recargar
          actualizarTimestamp();
          
          // Peque√±a pausa para mostrar el indicador
          setTimeout(() => {
            window.location.reload();
          }, 500);
        }
      } catch (error) {
        console.log('Error actualizando datos:', error);
        // Ocultar indicador en caso de error
        if (indicator) {
          indicator.style.display = 'none';
        }
      }
    }

    // Funci√≥n espec√≠fica para verificar cambios en estad√≠sticas principales
    async function verificarCambiosEstadisticas() {
      try {
        const response = await fetch('/gestion/dashboard/admin/?stats_only=1', {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Verificar si hay cambios en las estad√≠sticas principales
          const currentStats = {
            productos: parseInt(document.querySelector('.stats-grid .stat-card:nth-child(1) .stat-number').textContent),
            clientes: parseInt(document.querySelector('.stats-grid .stat-card:nth-child(2) .stat-number').textContent),
            pedidos: parseInt(document.querySelector('.stats-grid .stat-card:nth-child(3) .stat-number').textContent),
            notificaciones: parseInt(document.querySelector('.stats-grid .stat-card:nth-child(6) .stat-number').textContent)
          };
          
          // Si hay cambios, actualizar
          if (data.total_productos !== currentStats.productos || 
              data.total_clientes !== currentStats.clientes || 
              data.total_pedidos !== currentStats.pedidos || 
              data.total_notificaciones_no_leidas !== currentStats.notificaciones) {
            
            console.log('üìä Cambios detectados en estad√≠sticas principales, actualizando...');
            actualizarDatosGraficas();
          }
        }
      } catch (error) {
        console.log('Error verificando estad√≠sticas:', error);
      }
    }

    // Funci√≥n para actualizar las gr√°ficas autom√°ticamente
    function iniciarActualizacionAutomatica() {
      // Actualizar cada 2 minutos
      setInterval(actualizarDatosGraficas, 120000); // 2 minutos = 120000 ms
      
      // Actualizar cada vez que la ventana vuelve a estar activa
      let inactivo = false;
      
      window.addEventListener('blur', function() {
        inactivo = true;
      });
      
      window.addEventListener('focus', function() {
        if (inactivo) {
          inactivo = false;
          // Actualizar inmediatamente cuando vuelve el foco
          setTimeout(actualizarDatosGraficas, 500);
        }
      });
      
      // Actualizar cuando la p√°gina vuelve a estar visible
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden && inactivo) {
          setTimeout(actualizarDatosGraficas, 500);
        }
      });
    }

    // Funci√≥n para detectar cambios en los datos
    function verificarCambiosEnDatos() {
      let ultimaActualizacion = Date.now();
      
      // Verificar cada 30 segundos si hay cambios
      setInterval(function() {
        // Verificar si hay nuevos pedidos o cambios en las ventas
        fetch('/gestion/dashboard/admin/?ajax=1&timestamp=' + ultimaActualizacion, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        }).then(response => response.json())
        .then(data => {
          if (data && data.actualizar) {
            console.log('Detectados cambios en los datos, actualizando...');
            actualizarDatosGraficas();
            ultimaActualizacion = Date.now();
          }
        }).catch(error => {
          console.log('Error verificando cambios:', error);
        });
      }, 30000); // 30 segundos
    }

    // Funci√≥n para actualizar autom√°ticamente cuando se agregan nuevos datos
    function monitorearCambiosEnTiempoReal() {
      // Verificar cambios m√°s frecuentemente (cada 10 segundos)
      setInterval(function() {
        const ahora = new Date();
        const minutos = ahora.getMinutes();
        
        // Actualizar autom√°ticamente cada 5 minutos
        if (minutos % 5 === 0 && ahora.getSeconds() < 10) {
          console.log('Actualizaci√≥n programada cada 5 minutos');
          actualizarDatosGraficas();
        }
      }, 10000); // 10 segundos
    }

    // Iniciar todas las actualizaciones autom√°ticas
    iniciarActualizacionAutomatica();
    verificarCambiosEnDatos();
    monitorearCambiosEnTiempoReal();
    
    // Verificar estad√≠sticas principales cada 15 segundos
    setInterval(verificarCambiosEstadisticas, 15000);

    // Mensaje de confirmaci√≥n en consola
    console.log('‚úÖ Sistema de actualizaci√≥n autom√°tica completo activado');
    console.log('üìä Gr√°ficas: actualizaci√≥n cada 2 minutos');
    console.log('üìà Estad√≠sticas principales: verificaci√≥n cada 15 segundos');
    console.log('üîç Verificaci√≥n de cambios cada 30 segundos');
    console.log('‚ö° Actualizaci√≥n autom√°tica cada 5 minutos');
    console.log('üî¥ Todas las estad√≠sticas son en TIEMPO REAL');

    /* stylelint-enable */
    /* eslint-enable */
  </script>

</body>
</html>


